# DB

## RDBMS
  - ãƒ†ãƒ¼ãƒ–ãƒ«ã”ã¨ã«ãƒ‡ãƒ¼ã‚¿ã‚’åˆ†ã‘ã¦ä¿å­˜ãƒ»ç®¡ç†ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚·ã‚¹ãƒ†ãƒ 
    - MySQL
    - OracleDB
    - PostgreSQL

## ãƒ†ãƒ¼ãƒ–ãƒ«(ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£)
  - è¡Œï¼šãƒ¬ã‚³ãƒ¼ãƒ‰
  - å±æ€§ï¼šçµ¡ã‚€
  - å€¤ï¼šãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰

## ä¸»ã‚­ãƒ¼(Primary Key)
  - ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’ä¸€æ„ã«ç‰¹å®šã™ã‚‹ã‚­ãƒ¼
    - é‡è¤‡ã—ãªã„
    - å¤‰æ›´ã—ãªã„
  - ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ãƒ‡ãƒ¼ãƒ–ãƒ«ã§ã¯åŒã˜ãƒ¬ã‚³ãƒ¼ãƒ‰ã¯é‡è¤‡ã—ã¦ä¿æŒã—ãªã„

## å¤–éƒ¨ã‚­ãƒ¼(Foreign Key)
  - ä»–ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã¨çµåˆã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã™ã‚‹ã‚­ãƒ¼

# æ­£è¦åŒ–

## éæ­£è¦å½¢
  - è¡Œã¨åˆ—ã®ãƒ‡ãƒ¼ã‚¿ãŒ1å¯¾1ã¨ãªã‚‰ãªã„çŠ¶æ…‹

## ç¬¬1æ­£è¦åŒ–
  - è¡Œã¨åˆ—ã®ãƒ‡ãƒ¼ã‚¿ãŒ1å¯¾1ã®çŠ¶æ…‹ã¨ã™ã‚‹
  - ã¾ãŸãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’ä¸€æ„ã«ç‰¹å®šã™ã‚‹ä¸»ã‚­ãƒ¼ã‚’é¸å®š

## ç¬¬2æ­£è¦åŒ–
  - ä¸»ã‚­ãƒ¼ã®ä¸€éƒ¨ã«å¾“å±ã—ã¦ã„ã‚‹å±æ€§ã‚’åˆ¥ãƒ†ãƒ¼ãƒ–ãƒ«ã«åˆ†ã‘ã‚‹
  - éƒ¨åˆ†é–¢æ•°å¾“å±ã‚’å–ã‚Šé™¤ãå‡¦ç†

### éƒ¨åˆ†é–¢æ•°å¾“å±
  - åº—é‹ªIDã€å•†å“IDã®ã©ã¡ã‚‰ã‹ä¸€æ–¹ã®å±æ€§ã«ã‚ˆã£ã¦ç‰¹å®šã•ã‚Œã‚‹å±æ€§ï¼ˆåº—èˆ—åã€å•†å“åãªã©ï¼‰
    - ä¸»ã‚­ãƒ¼ã®ä¸€éƒ¨ã«ã‚ˆã£ã¦æ±ºã¾ã‚‹ã‚‚ã®

### å®Œå…¨é–¢æ•°å¾“å±
  - ä¸»ã‚­ãƒ¼ï¼ˆåº—é‹ªIDã€å•†å“IDã®äºŒã¤ã®å±æ€§ï¼‰ã«ã‚ˆã£ã¦ä¸€æ„ã«ç‰¹å®šã•ã‚Œã‚‹å±æ€§ï¼ˆæ•°é‡ï¼‰
    - ä¸»ã‚­ãƒ¼å…¨ä½“ã‚’é€šã—ã¦ç‰¹å®šã™ã‚‹ã‚‚ã®

## ç¬¬3æ­£è¦åŒ–
  - ä¸»ã‚­ãƒ¼ä»¥å¤–ã®å±æ€§ã«å¾“å±ã—ã¦ã„ã‚‹å±æ€§ã‚’åˆ¥ãƒ†ãƒ¼ãƒ–ãƒ«ã«åˆ†ã‘ã‚‹

### æ¨ç§»çš„é–¢æ•°å¾“å±
  - ä¸»ã‚­ãƒ¼ä»¥å¤–ã®å±æ€§ã«é–¢æ•°å¾“å±ã—ã¦ã„ã‚‹å±æ€§ã®ã“ã¨

## ERå›³
  - ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ï¼‰ã®é–¢ä¿‚ã‚’å¯è¦–åŒ–ã™ã‚‹ãŸã‚ã®è¨˜æ³•

### IEï¼ˆInformation Engineeringï¼‰
  - ERå›³ã«ç½®ã„ã¦ãƒ†ãƒ¼ãƒ–ãƒ«ã®é–¢ä¿‚ã‚’è¡¨ã™ä»£è¡¨çš„ãªè¨˜æ³•
  - ãƒ†ãƒ¼ãƒ–ãƒ«åŒå£«ã®ãƒ¬ã‚³ãƒ¼ãƒ‰æ•°ã¯ã‚«ãƒ¼ãƒ‡ã‚£ãƒŠã‚Šãƒ†ã‚£ã¨å‘¼ã¶

#### ã‚«ãƒ¼ãƒ‡ã‚£ãƒŠã‚Šãƒ†ã‚£
  - å¤š
  - 0
  - 1

## SQL(Structured Query Language)
  - DBã‚’æ“ä½œã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã™ã‚‹è¨€èª
  - DBã«å¯¾ã™ã‚‹å‘½ä»¤ï¼ˆã‚¹ãƒ†ãƒ¼ãƒˆãƒ¡ãƒ³ãƒˆï¼‰ã‚’è¨˜è¿°ã™ã‚‹ãŸã‚ã®è¨€èª
    - ï¼ã‚¯ã‚¨ãƒª

### SQLã®ç¨®é¡
  - DDL(Data Definition Language)
    - ãƒ‡ãƒ¼ã‚¿å®šç¾©è¨€èª
  - DML(Data Manipulation Language)
    - ãƒ‡ãƒ¼ã‚¿æ“ä½œè¨€èª
  - DCL(ã‚¢ã‚¯ã‚»ã‚¹åˆ¶é™)ã€TCLï¼ˆãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³åˆ¶å¾¡ï¼‰

#### ãƒ‡ãƒ¼ã‚¿å®šç¾©è¨€èªï¼ˆDDLï¼‰
  - DBã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®å®šç¾©ã«ä½¿ç”¨
  - DBã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ä¾‹
    - ãƒ†ãƒ¼ãƒ–ãƒ«
    - ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
    - ãƒ•ã‚¡ãƒ³ã‚¯ã‚·ãƒ§ãƒ³
    - ãƒˆãƒªã‚¬ãƒ¼ãªã©

#### ãƒ‡ãƒ¼ã‚¿æ“ä½œè¨€èªï¼ˆDMLï¼‰
  - ãƒ†ãƒ¼ãƒ–ãƒ«ãƒ‡ãƒ¼ã‚¿ã®æ“ä½œã«ä½¿ç”¨
  - ãƒ‡ãƒ¼ã‚¿ã®æ“ä½œã®ä¾‹
    - å–å¾—
    - æ›´æ–°
    - å‰Šé™¤
    - æŒ¿å…¥ãªã©

### DBæ“ä½œ
  - DBä½œæˆ

```
CREATE database test_db;
```

  - DBå‰Šé™¤

```
DROP database test_db;
```

### ãƒ‡ãƒ¼ãƒ–ãƒ«æ“ä½œ
  - ãƒ†ãƒ¼ãƒ–ãƒ«ã®ä½œæˆ
  - ã‚³ãƒ¡ãƒ³ãƒˆã®ç”¨é€”ã¯å’Œè¨³ï¼ˆãŒå¤šã„ï¼‰

```
CREATE table ãƒ†ãƒ¼ãƒ–ãƒ«å (
  ã‚«ãƒ©ãƒ å ãƒ‡ãƒ¼ã‚¿å‹ default ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ åˆ¶ç´„ comment 'ã‚³ãƒ¡ãƒ³ãƒˆ',
  ...,
  è¡¨åˆ¶ç´„
) ENGINE = [INNODB | MyISAM]
```

  - ä¾‹

```
CREATE table test_db.test_table (
	id int(6) unsigned default 0 comment 'ID',
	val varchar(20) default 'hello' comment 'å€¤'
);
```

  - ãƒ†ãƒ¼ãƒ–ãƒ«ã®å‰Šé™¤

```
DROP table test_db.test_table;
```

  - ãƒ†ãƒ¼ãƒ–ãƒ«è¡¨ç¤º

```
desc test_db.test_table;
show full columns from test_db.test_table;
show CREATE table test_db.test_table;
```

  - ãƒ†ãƒ¼ãƒ–ãƒ«ã®é¸æŠ

```
use test_db;
select database();
```

### ãƒ‡ãƒ¼ã‚¿å‹
  - INTï¼šæ•´æ•°å€¤
  - FLOATï¼šæµ®å‹•å°æ•°ç‚¹
    - â€»æ­£ã®å€¤ã«é™å®šã™ã‚‹å ´åˆã¯unsignedã‚’ä½¿ç”¨
  - DATATIMEï¼šæ—¥æ™‚
  - TIMESTAMPï¼šæ—¥æ™‚
  - CHARï¼šå›ºå®šé•·æ–‡å­—åˆ—
  - VARCHARï¼šå¯å¤‰é•·æ–‡å­—åˆ—
  - BLOBï¼šãƒã‚¤ãƒŠãƒªãƒ‡ãƒ¼ã‚¿ï¼ˆç”»åƒã‚„éŸ³å£°ã€å‹•ç”»ãªã©ï¼‰

### åˆ¶ç´„
  - UNIQUEï¼šä¸€æ„åˆ¶ç´„
  - NOT NULLï¼šNOT NULLåˆ¶ç´„
  - PRIMARY KEYï¼šä¸»ã‚­ãƒ¼åˆ¶ç´„
  - FOREIGN KEYï¼šå¤–éƒ¨ã‚­ãƒ¼åˆ¶ç´„
  - CHECKåˆ¶ç´„ï¼šãƒã‚§ãƒƒã‚¯åˆ¶ç´„ï¼ˆMySQL8.0ï¼‰

### è¤‡åˆä¸»ã‚­ãƒ¼

```
CREATE table test_db.test_table (
	key1 int,
	key2 int,
	primary key (key1, key2)
);
```

### Auto increment
  - è‡ªå‹•ã§æ¡ç•ª
  - indexã¨ã¯æ¤œç´¢ã‚’é«˜é€ŸåŒ–ã™ã‚‹ä»•çµ„ã¿
  - ä¸€ã¤ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã«ä¸€ã¤ã—ã‹ä»˜ä¸ã§ããªã„
  - defaultå€¤ã‚’è¨­å®šã™ã‚‹ã“ã¨ã¯ã§ããªã„

### ãƒ†ãƒ¼ãƒ–ãƒ«å®šç¾©ã®å¤‰æ›´

```
alter table test_db.test_table
add column key2 varchar(20) not null,
add column key3 varchar(20) not null;

alter table test_db.test_table
add column key4 varchar(20) after key2;

alter table test_db.test_table
add column key5 varchar(20) first;

alter table test_db.test_table
modify column key5 int not null;

alter table test_db.test_table
drop column key5;

alter table test_db.test_table
modify column key1 int(11) NOT NULL;

alter table test_db.test_table
drop primary key;

show create table test_db.test_table;
```


## å¤–éƒ¨ã‚­ãƒ¼ã®ä½œæˆ
  - æ³¨æ„)
    - å‹æƒ…å ±ã¯åˆã‚ã›ã‚‹
    - ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®è‡ªå‹•ä»˜ä¸
      - æ—¢ã«æœ‰åŠ¹ãªã‚­ãƒ¼ãŒå­˜åœ¨ã™ã‚‹å ´åˆã«ã¯ä½œæˆã—ãªã„
      - ä¾‹ï¼šè¤‡åˆä¸»ã‚­ãƒ¼ã®ä¸€ç•ªæœ€åˆã¯ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãŒä½œæˆã•ã‚Œãªã„

### ON DELETE
  - ãƒ¬ã‚³ãƒ¼ãƒ‰ãŒå‰Šé™¤ã•ã‚ŒãŸéš›ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³

### ON UPDATE
  - ãƒ¬ã‚³ãƒ¼ãƒ‰ãŒæ›´æ–°ã•ã‚ŒãŸéš›ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³

### CASCADE
  - è¦ªãƒ†ãƒ¼ãƒ–ãƒ«ã®è¡Œã‚’å‰Šé™¤ã¾ãŸã¯æ›´æ–°ã—ã€å­ãƒ†ãƒ¼ãƒ–ãƒ«å†…ã®ä¸€è‡´ã™ã‚‹è¡Œã‚’è‡ªå‹•çš„ã«å‰Šé™¤ã¾ãŸã¯æ›´æ–°ã™ã‚‹

### RESTRICT
  - è¦ªãƒ†ãƒ¼ãƒ–ãƒ«ã«å¯¾ã™ã‚‹å‰Šé™¤ã¾ãŸã¯æ›´æ–°æ“ä½œã‚’æ‹’å¦ã™ã‚‹
  - ON DELETEã¾ãŸã¯ON UPDATEå¥ã‚’çœç•¥ã™ã‚‹ã“ã¨ã¨åŒç¾©


```
alter table ãƒ†ãƒ¼ãƒ–ãƒ«å
add constraint åˆ¶ç´„åï¼ˆâ€»å‰Šé™¤ã™ã‚‹éš›ã«ä½¿ç”¨ï¼‰
foreign key (å¯¾è±¡ã®ã‚­ãƒ¼å)
    references è¦ªãƒ†ãƒ¼ãƒ–ãƒ«å(ãƒ†ãƒ¼ãƒ–ãƒ«ã‚­ãƒ¼å)
    on update cascade
    on delete restrict; (çœç•¥å¯)

```

## ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ãƒ†ãƒ¼ãƒ–ãƒ«ã¨ãƒã‚¹ã‚¿ãƒ†ãƒ¼ãƒ–ãƒ«ã®è­˜åˆ¥

### ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ãƒ†ãƒ¼ãƒ–ãƒ«
  - ã‚¢ãƒ—ãƒªã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’é »ç¹ã«æŒ¿å…¥ã€æ›´æ–°ã™ã‚‹ã‚ˆã†ãªãƒ†ãƒ¼ãƒ–ãƒ«
  - ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒ†ãƒ¼ãƒ–ãƒ«ã¨ã‚‚å‘¼ã¶
    - ä¾‹ï¼‰ã‚ªãƒ¼ãƒ€ãƒ¼æƒ…å ±ã€é¡§å®¢æƒ…å ±ã€è«‹æ±‚æƒ…å ±ãªã©
  - å…ˆé ­ã«ENTã€TXNã€TRNãªã©ã‚’ã¤ã‘ã‚‹å ´åˆãŒå¤šã„

### ãƒã‚¹ã‚¿ãƒ†ãƒ¼ãƒ–ãƒ«
  - å‚ç…§å€¤ã‚’ä¿æŒã™ã‚‹ç”¨ã®ãƒ†ãƒ¼ãƒ–ãƒ«
  - ã‚¢ãƒ—ãƒªã‹ã‚‰ã¯åŸºæœ¬çš„ã«å€¤ã‚’æŒ¿å…¥ã€å¤‰æ›´ã—ãªã„
    - ä¾‹) å•†å“ä¸€è¦§ã€åº—é‹ªä¸€è¦§
  - å…ˆé ­ã«MSTã¨ã¤ã‘ã‚‹ã“ã¨ãŒå¤šã„

#### è«–ç†ãƒ•ãƒ©ã‚°ã®å°å…¥ï¼ˆdelete_flgï¼‰
  - ãƒ¬ã‚³ãƒ¼ãƒ‰ã®æœ‰åŠ¹æ€§ã‚’è­˜åˆ¥ã™ã‚‹ãŸã‚ã®ãƒ•ãƒ©ã‚°
    - ä¾‹ï¼‰delete_flg = 1ã®å ´åˆã«ã¯ç„¡åŠ¹ãƒ¬ã‚³ãƒ¼ãƒ‰ã¨ã—ã¦ä½¿ç”¨

#### æ›´æ–°æ—¥ã€æ›´æ–°è€…ã®å°å…¥ï¼ˆupdated_atã€updated_byï¼‰
  - ãƒ¬ã‚³ãƒ¼ãƒ‰ãŒã„ã¤ã€èª°ã«ã‚ˆã£ã¦å¤‰æ›´ã•ã‚ŒãŸã®ã‹ã®è¨¼è·¡ã‚’ä¿æŒã™ã‚‹ãŸã‚ã®å±æ€§


```
use test_db;

DROP table stocks;
DROP table products;
DROP table shops;
DROP table prefs;

create table mst_products (
	id int(10) unsigned auto_increment primary key,
	name varchar(20) not null,
	delete_flg int(1) not null default 0,
	updated_at timestamp default current_timestamp on update current_timestamp,
	updated_by varchar(20) not null
);

create table mst_prefs (
	id int(2) unsigned auto_increment primary key,
	name varchar(10) not null,
	delete_flg int(1) not null default 0,
	updated_at timestamp default current_timestamp on update current_timestamp,
	updated_by varchar(20) not null
);

create table mst_shops (
	id int(10) unsigned auto_increment primary key,
	name varchar(50) not null,
	pref_id int(2) unsigned not null,
	delete_flg int(1) not null default 0,
	updated_at timestamp default current_timestamp on update current_timestamp,
	updated_by varchar(20) not null,
	constraint fk_pref_id
		foreign key(pref_id)
		references mst_prefs(id)
		on update cascade
);

create table txn_stocks (
	product_id int unsigned,
	shop_id int unsigned,
	amount int unsigned not null,
	delete_flg int(1) not null default 0,
	updated_at timestamp default current_timestamp on update current_timestamp,
	updated_by varchar(20) not null,
	primary key(product_id, shop_id),
	constraint fk_product_id
		foreign key (product_id)
		references mst_products(id)
		on update cascade,
	constraint fk_shop_id
		foreign key (shop_id)
		references mst_shops(id)
		on update cascade
);

```

## DMLæ“ä½œ

### ãƒ¬ã‚³ãƒ¼ãƒ‰ã®æŒ¿å…¥

  - å˜ä¸€ãƒ¬ã‚³ãƒ¼ãƒ‰ã®æŒ¿å…¥

```
insert into ãƒ†ãƒ¼ãƒ–ãƒ«åï¼ˆå±æ€§1ã€å±æ€§2ï¼‰values ("å€¤1", "å€¤2");

```

ä¾‹
```
INSERT into test_db.mst_prefs(name, updated_by) values('åŒ—æµ·é“', 'nagatak');

```

  - è¤‡æ•°ãƒ¬ã‚³ãƒ¼ãƒ‰ã®æŒ¿å…¥

```
insert into ãƒ†ãƒ¼ãƒ–ãƒ«åï¼ˆå±æ€§1ã€å±æ€§2ï¼‰values ï¼ˆå€¤1ã€å€¤2ï¼‰,
ï¼ˆå€¤1ã€å€¤2ï¼‰,
ï¼ˆå€¤1ã€å€¤2ï¼‰,
ï¼ˆå€¤1ã€å€¤2ï¼‰;

```

ä¾‹

```
INSERT into test_db.mst_prefs(name, updated_by) values('å±±å½¢', 'nagatak'),
('é’æ£®', 'nagatak');

```

### ãƒ¬ã‚³ãƒ¼ãƒ‰ã®å–å¾—

```
select å–å¾—ã—ãŸã„å±æ€§ã€€[as label] from ãƒ†ãƒ¼ãƒ–ãƒ«å [as label]

```

#### å–å¾—ã—ãŸã„å±æ€§ï¼š
  - *ï¼šå…¨ã¦ã®å±æ€§ã‚’å–å¾—
  - distinctï¼šé‡è¤‡ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’çœã
  - asï¼šåˆ—ãƒ©ãƒ™ãƒ«ã®å¤‰æ›´ï¼ˆasã¯çœç•¥å¯èƒ½ï¼‰

```
select COUNT(*) as "ä»¶æ•°" from test_db.mst_prefs as mp
```

```
select DISTINCT name "éƒ½é“åºœçœŒå" from test_db.mst_prefs as mp

```

#### auto_incrementã®åˆæœŸåŒ–
  - ä¾‹

```
alter table test_db.mst_prefs auto_increment = 1;
```

### æ¡ä»¶å¥
  - =ï¼šä¸€è‡´

```
SELECT * from test_db.txn_stocks
WHERE product_id = 1;

```

  - <>, !=ï¼šéä¸€è‡´

```
SELECT * from test_db.txn_stocks
WHERE product_id <> 1;

SELECT * from test_db.txn_stocks
WHERE product_id != 1;
```

  - >, >=, <, >, <=ï¼šæ•°å€¤ã®æ¯”è¼ƒ

```
SELECT * from test_db.txn_stocks
WHERE amount >= 60;
```

  - A and Bï¼šAã‹ã¤B

```
SELECT * from test_db.txn_stocks
WHERE product_id =1 and shop_id =1;

```

  - A or Bï¼šAã¾ãŸã¯B

```
SELECT * from test_db.txn_stocks
WHERE product_id =1 or shop_id =1;

```

  - ()ï¼šæ¡ä»¶ã‚’ããã‚‹

```
SELECT * from test_db.txn_stocks
where (product_id=1 and shop_id=1)
or (product_id=2 and shop_id=2);
```

  - likeï¼š%ã§éƒ¨åˆ†ä¸€è‡´æ¤œç´¢

```
SELECT * FROM test_db.mst_shops
WHERE name like 'åº—é‹ª%';
```

  - inï¼šã„ãšã‚Œã‹ã®å€¤ã«ä¸€è‡´

```
SELECT * FROM test_db.mst_shops
WHERE name IN ('åº—é‹ªA', 'åº—é‹ªB');
```

  - not inï¼šã„ãšã‚Œã®å€¤ã«ã‚‚ä¸€è‡´ã—ãªã„

```
SELECT * FROM test_db.mst_shops
WHERE name NOT IN ('åº—é‹ªA', 'åº—é‹ªB');
```

  - between A and Bï¼šAã‹ã‚‰Bã®å€¤

```
SELECT * FROM test_db.txn_stocks
WHERE amount BETWEEN 60 AND 100;
```

  - is not nullï¼šnullä»¥å¤–ã«ä¸€è‡´

```
SELECT * FROM test_db.txn_stocks
WHERE amount is NOT NULL;

```

  - is nullï¼šnullã«ä¸€è‡´

```
SELECT * FROM test_db.txn_stocks
WHERE amount is NULL;
```

#### ä¸¦ã¹æ›¿ãˆ
  - order by
    - ascï¼ˆæ˜‡é †ï¼‰ãŒãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼ˆçœç•¥å¯èƒ½ï¼‰

```
SELECT * FROM test_db.txn_stocks
order by amount DESC;

SELECT * FROM test_db.txn_stocks
where amount > 50
order by amount DESC;

SELECT * FROM test_db.txn_stocks
order by product_id desc,
shop_id asc;
```

#### limitã¨offset
  - limitï¼šå–å¾—ãƒ¬ã‚³ãƒ¼ãƒ‰æ•°ã®åˆ¶å¾¡
  - offsetï¼šå–å¾—é–‹å§‹ä½ç½®ã®æ±ºå®š
  - offsetã‚’çœç•¥ã—ãŸå ´åˆã¯ã€è¨˜è¼‰é †ãŒé€†ã«ãªã‚‹

```
SELECT * FROM test_db.txn_stocks
order by product_id desc,
shop_id asc
limit 2 offset 2;

SELECT * FROM test_db.txn_stocks
order by product_id desc,
shop_id asc
limit 1,2;
```

### ãƒ†ã‚¹ãƒˆ
  - 'åŒ—æµ·é“', 'é’æ£®'ã®idã‚’å–å¾—ã—ã¦ã¿ã‚ˆã†

```
SELECT id from test_db.mst_prefs
WHERE name in ('åŒ—æµ·é“', 'é’æ£®');
```

  - amount ãŒ 60 ~ 80 ã®ãƒ¬ã‚³ãƒ¼ãƒ‰ã®shop_idã‚’å–å¾—ã—ã¦ã¿ã‚ˆã†ã€‚

```
SELECT shop_id from test_db.txn_stocks
WHERE amount BETWEEN 60 AND 80;
```

  - amount ãŒ 50 ä»¥ä¸‹ã®ãƒ¬ã‚³ãƒ¼ãƒ‰æ•°ã‚’å–å¾—ã—ã¦ã¿ã‚ˆã†ã€‚

```
SELECT count(*) from test_db.txn_stocks
WHERE amount <= 50;
```

  - å•†å“åãŒ 'æ¤…å­' ä»¥å¤–ã®nameå±æ€§ã®å€¤ã‚’å•†å“åã¨ã„ã†ãƒ©ãƒ™ãƒ«ã§å–å¾—ã—ã¦ã¿ã‚ˆã†ã€‚

```
SELECT name "å•†å“å" from test_db.mst_products
where name <> 'æ¤…å­';
```

  - shop_idãŒ2ã‹ã¤product_idãŒ1ã®ãƒ¬ã‚³ãƒ¼ãƒ‰ã®æ›´æ–°æ—¥æ™‚ã¨æ›´æ–°è€…ã‚’å–å¾—ã—ã¦ã¿ã‚ˆã†ã€‚

```
SELECT updated_at, updated_by from test_db.txn_stocks
WHERE shop_id =2 AND product_id = 1;
```

  - shop_idãŒ2ã‹ã¤amountãŒ70ã‚ˆã‚Šå¤§ãã„
  - ã¾ãŸã¯ã€shop_idãŒ3ã‹ã¤amountãŒ70ã‚ˆã‚Šå¤§ãã„ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’å–å¾—ã—ã¦ã¿ã‚ˆã†ã€‚

```
SELECT * from test_db.txn_stocks
WHERE (shop_id=2 and amount>70) OR (shop_id=3 and amount >70);
```

  - åº—èˆ—åã« A ãŒå«ã¾ã‚Œã‚‹åº—èˆ—ã®pref_idã‚’éƒ½é“åºœçœŒIDã¨ã„ã†ãƒ©ãƒ™ãƒ«å–å¾—ã—ã¦ã¿ã‚ˆã†ã€‚

```
SELECT pref_id "éƒ½é“åºœçœŒID" from test_db.mst_shops
WHERE name like '%A%';
```

  - shop_id ãŒ 2 ã®ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’åœ¨åº«æ•°ï¼ˆamountï¼‰ãŒå¤šã„é †ã«å–å¾—ã—ã¦ã¿ã‚ˆã†ã€‚

```
SELECT * FROM test_db.txn_stocks
WHERE shop_id = 2
ORDER BY amount DESC;
```

  - åœ¨åº«æ•°ãŒä¸Šã‹ã‚‰ï¼’ç•ªç›®ã«å¤šã„ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’å–å¾—ã—ã¦ã¿ã‚ˆã†ã€‚


```
SELECT * FROM test_db.txn_stocks
order by amount DESC
limit 1 offset 1;
```

### ãƒ‡ãƒ¼ã‚¿ã®æ›´æ–°
  - æ›¸ãæ–¹
  - æ›´æ–°ã™ã‚‹ã¨ãã¯selectæ–‡ã§ç¢ºèªã—ã¦ã‹ã‚‰è¡Œã†
  - cascadeåˆ¶ç´„ãŒã‚ã‚‹å ´åˆã€å‚ç…§å…ˆã®ãƒ†ãƒ¼ãƒ–ãƒ«ã§å¤‰æ›´ãŒã‚ã£ãŸå ´åˆã«è‡ªå‹•çš„ã«å‚ç…§å…ˆã«ä¼šã†ã‚ˆã†ã«å¤‰æ›´ã•ã‚Œã‚‹

```
update ãƒ†ãƒ¼ãƒ–ãƒ«å set å±æ€§1 = å€¤1, ... where æ¡ä»¶
```

```
update test_db.txn_stocks set amount = 50
WHERE product_id = 1 and shop_id =1;
```

## ãƒ†ãƒ¼ãƒ–ãƒ«ã®çµåˆ
  - å†…éƒ¨çµåˆ(inner join)
    - 2ã¤ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’çµåˆã—ãŸéš›ã«ä¸¡ãƒ†ãƒ¼ãƒ–ãƒ«ã«å­˜åœ¨ã™ã‚‹ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’è¿”ã™
    - 2ã¤ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã®é‡ãªã‚‹éƒ¨åˆ†ãŒå¯¾è±¡

  - å·¦å¤–éƒ¨çµåˆ(left join)
    - 2ã¤ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’çµåˆã—ãŸéš›ã«å·¦å´ãƒ†ãƒ¼ãƒ–ãƒ«ã«å­˜åœ¨ã™ã‚‹ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’è¿”ã™
    - ãƒ†ãƒ¼ãƒ–ãƒ«AãŒå¯¾è±¡

  - å³å¤–éƒ¨çµåˆ(right join)
    - 2ã¤ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’çµåˆã—ãŸéš›ã«å³å´ãƒ†ãƒ¼ãƒ–ãƒ«ã«å­˜åœ¨ã™ã‚‹ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’è¿”ã™
    - ãƒ†ãƒ¼ãƒ–ãƒ«BãŒå¯¾è±¡

  - å¤–éƒ¨çµåˆ(outer join)
    - æ¡ä»¶ã«å½“ã¦ã¯ã¾ã‚‹2ã¤ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã®å…¨ã¦ã®ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’è¿”ã™

### å†…éƒ¨çµåˆ

```
select * from ãƒ†ãƒ¼ãƒ–ãƒ«1
inner join ãƒ†ãƒ¼ãƒ–ãƒ«2
on ãƒ†ãƒ¼ãƒ–ãƒ«1.å€¤ãŒä¸€è‡´ã™ã‚‹å±æ€§ = ãƒ†ãƒ¼ãƒ–ãƒ«2.å€¤ãŒä¸€è‡´ã™ã‚‹å±æ€§;
```

```
select * from test_db.mst_shops ms
inner join test_db.mst_prefs mp
on ms.pref_id = mp.id;
```

```
select ms.name "åº—é‹ªå", mp.name "éƒ½é“åºœçœŒå" from test_db.mst_shops ms
inner join test_db.mst_prefs mp
on ms.pref_id = mp.id;
```

```
1	åº—é‹ªA	1	0	2021-07-12 08:11:19	nagatak	1	åŒ—æµ·é“	0	2021-07-10 21:54:47	nagatak
2	åº—é‹ªB	2	0	2021-07-11 10:48:23	nagatak	2	é’æ£®	0	2021-07-10 21:54:47	nagatak
3	åº—é‹ªC	3	0	2021-07-11 10:48:23	nagatak	3	å²©æ‰‹	0	2021-07-10 21:54:47	nagatak
```

### å¤–éƒ¨çµåˆ

```
select * from å·¦ãƒ†ãƒ¼ãƒ–ãƒ«
left join å³ãƒ†ãƒ¼ãƒ–ãƒ«
on å·¦ãƒ†ãƒ¼ãƒ–ãƒ«.å€¤ãŒä¸€è‡´ã™ã‚‹å±æ€§ = å³ãƒ†ãƒ¼ãƒ–ãƒ«.å€¤ãŒä¸€è‡´ã™ã‚‹å±æ€§;
```

  - ä¸Šã®SQlã¯å·¦å¤–éƒ¨çµåˆã§ã‚ã‚Šã€å·¦å´ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã®å€¤ã¯å…¨ã¦æŒã£ã¦ãã‚‹ã€‚å¯¾ã—ã¦çµåˆå…ˆã®å³ãƒ†ãƒ¼ãƒ–ãƒ«ã§ã¯ã€å·¦å´ãƒ†ãƒ¼ãƒ–ãƒ«ã«åˆã‚ã›ã¦å€¤ã‚’ã¨ã£ã¦ãã‚‹

```
SELECT mp.name "éƒ½é“åºœçœŒå", ms.name "åº—èˆ—å"
from test_db.mst_shops ms
right join test_db.mst_prefs mp
on ms.pref_id = mp.id;
```

  - ä¸Šè¨˜ã¯å³å¤–éƒ¨çµåˆ

### ç†è§£åº¦ãƒã‚§ãƒƒã‚¯

```
select * from test_db.txn_stocks ts
inner join test_db.mst_shops ms
on ts.shop_id = ms.id;

select ms.name "åº—èˆ—å", ts.product_id "å•†å“ID", ts.amount "åœ¨åº«æ•°"
from test_db.txn_stocks ts
inner join test_db.mst_shops ms
on ts.shop_id = ms.id
order by ms.name;

select ms.name "åº—èˆ—å", mp.name "å•†å“å", ts.amount "åœ¨åº«æ•°"
from test_db.txn_stocks ts
inner join test_db.mst_shops ms
on ts.shop_id = ms.id
inner join test_db.mst_products mp
on ts.product_id = mp.id
order by ms.name;

select ms.name "åº—èˆ—å", mpr.name "éƒ½é“åºœçœŒå", mp.name "å•†å“å", ts.amount "åœ¨åº«æ•°"
from test_db.txn_stocks ts
inner join test_db.mst_shops ms
on ts.shop_id = ms.id
inner join test_db.mst_products mp
on ts.product_id = mp.id
inner join test_db.mst_prefs mpr
on mpr.id = ms.pref_id
order by ms.name;
```

## ACIDç‰¹æ€§ ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³

### ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³
  - ä¸€é€£ã®SQLå‡¦ç†ã®ã‚°ãƒ«ãƒ¼ãƒ—ã®ã“ã¨
  - SQLã¯DMLã«é™ã‚‹

### ACIDç‰¹æ€§
  - ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å‡¦ç†ã§æ‹…ä¿ã•ã‚Œã‚‹4ã¤ã®è¦ç´ ã®é ­æ–‡å­—
    - Atomicityï¼ˆåŸå­æ€§ï¼‰
    - Consistencyï¼ˆä¸€è²«æ€§ï¼‰
    - Isolationï¼ˆç‹¬ç«‹æ€§ï¼‰
    - Durabilityï¼ˆæ°¸ç¶šæ€§ï¼‰

### Atomicity
  - SQLãŒå…¨ã¦æˆåŠŸã€ã‚‚ã—ãã¯å…¨ã¦å¤±æ•—ã™ã‚‹ã“ã¨ãŒä¿è¨¼ã•ã‚Œã¦ã„ã‚‹ã“ã¨

### Consistency
  - ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã®çµæœãŒæ•´åˆæ€§ã‚’ä¿ã¤ã“ã¨ãŒä¿è¨¼ã•ã‚Œã‚‹ã“ã¨
  - å¤–éƒ¨ã‚­ãƒ¼åˆ¶ç´„ã®CASCADEã‚„ãƒˆãƒªã‚¬ãƒ¼ãªã©ã«ã‚ˆã‚‹å€¤ã®å¤‰æ›´ã‚‚commitã€rollbackã«ã‚ˆã£ã¦æ•´åˆæ€§ãŒæ‹…ä¿ã•ã‚Œã‚‹ã“ã¨

### Isolation
  - ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å‡¦ç†ä¸­ã®çŠ¶æ…‹ã¯ä»–ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‹ã‚‰ç‹¬ç«‹ã—ã¦ã„ã‚‹ã“ã¨ãŒä¿è¨¼ã•ã‚Œã¦ã„ã‚‹ã“ã¨

### Durability
  - ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å®Œäº†å¾Œã®ãƒ‡ãƒ¼ã‚¿ã¯æ°¸ç¶šçš„ã«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿æŒã•ã‚Œã‚‹ã“ã¨ãŒä¿è¨¼ã•ã‚Œã¦ã„ã‚‹ã“ã¨


### ACIDå®Ÿè·µ

```
-- ã‚»ãƒƒã‚·ãƒ§ãƒ³A
start transaction

INSERT into test_db.txn_stocks(product_id, shop_id, amount, updated_by)
values (1, 3, 20, 'nagatak');

-- åŒä¸€ã‚»ãƒƒã‚·ãƒ§ãƒ³å†…ã®ç¢ºèª
select * from test_db.txn_stocks
where (product_id = 1 and shop_id = 1)
or (product_id=1 and shop_id=3);

UPDATE  test_db.txn_stocks set amount = 1000
WHERE product_id = 1 and shop_id =1;

-- æˆåŠŸ
commit;

-- å¤±æ•—
 rollback;
```

## ãƒ­ãƒƒã‚¯ã¨ãƒ‡ãƒƒãƒ‰ãƒ­ãƒƒã‚¯
### ãƒ­ãƒƒã‚¯
  - ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°ã™ã‚‹å‰ã«è¡Œã€ã¾ãŸã¯ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä»–ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‹ã‚‰æ›´æ–°ã•ã›ãªã„ã‚ˆã†ã«ã™ã‚‹ã“ã¨
    - ä¾‹ï¼šãƒ†ãƒ¼ãƒ–ãƒ«ãƒ­ãƒƒã‚¯ã€è¡Œãƒ­ãƒƒã‚¯

### ãƒ‡ãƒƒãƒ‰ãƒ­ãƒƒã‚¯
  - è¤‡æ•°ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒãã‚Œãã‚Œãƒ­ãƒƒã‚¯è§£é™¤å¾…ã¡ã‚’è¡Œã„ã€å‡¦ç†ãŒå®Œäº†ã—ãªã„çŠ¶æ…‹

```

=====================================
2021-07-14 08:00:06 0x30b82c000 INNODB MONITOR OUTPUT
=====================================
Per second averages calculated from the last 21 seconds
-----------------
BACKGROUND THREAD
-----------------
srv_master_thread loops: 203 srv_active, 0 srv_shutdown, 62238 srv_idle
srv_master_thread log flush and writes: 62441
----------
SEMAPHORES
----------
OS WAIT ARRAY INFO: reservation count 1137
OS WAIT ARRAY INFO: signal count 989
RW-shared spins 0, rounds 414, OS waits 205
RW-excl spins 0, rounds 1508, OS waits 27
RW-sx spins 4, rounds 120, OS waits 4
Spin rounds per wait: 414.00 RW-shared, 1508.00 RW-excl, 30.00 RW-sx
------------------------
LATEST FOREIGN KEY ERROR
------------------------
2021-07-10 10:36:14 0x30b870000 Error in foreign key constraint of table test_db/#sql-1749b_27d:

foreign key (shop_id)
references shopss(id)
on UPDATE cascade
on DELETE restrict:
Cannot resolve table name close to:
(id)
on UPDATE cascade
on DELETE restrict
------------------------
LATEST DETECTED DEADLOCK
------------------------
2021-07-14 07:59:11 0x30b870000
*** (1) TRANSACTION:
TRANSACTION 29916, ACTIVE 43 sec starting index read
mysql tables in use 1, locked 1
LOCK WAIT 3 lock struct(s), heap size 1136, 2 row lock(s), undo log entries 1
MySQL thread id 937, OS thread handle 13078020096, query id 2738 localhost 127.0.0.1 root updating
/* ApplicationName=DBeaver 21.1.2 - SQLEditor <Script.sql> */ UPDATE test_db.txn_stocks set amount = 500
WHERE product_id = 1 and shop_id = 2
*** (1) WAITING FOR THIS LOCK TO BE GRANTED:
RECORD LOCKS space id 371 page no 3 n bits 80 index PRIMARY of table `test_db`.`txn_stocks` trx id 29916 lock_mode X locks rec but not gap waiting
Record lock, heap no 3 PHYSICAL RECORD: n_fields 8; compact format; info bits 0
 0: len 4; hex 00000001; asc     ;;
 1: len 4; hex 00000002; asc     ;;
 2: len 6; hex 0000000074dd; asc     t ;;
 3: len 7; hex 39000001ea2346; asc 9    #F;;
 4: len 4; hex 000003e8; asc     ;;
 5: len 4; hex 80000000; asc     ;;
 6: len 4; hex 60ee1aa4; asc `   ;;
 7: len 7; hex 6e61676174616b; asc nagatak;;

*** (2) TRANSACTION:
TRANSACTION 29917, ACTIVE 27 sec starting index read
mysql tables in use 1, locked 1
3 lock struct(s), heap size 1136, 2 row lock(s), undo log entries 1
MySQL thread id 1350, OS thread handle 13078298624, query id 2740 localhost 127.0.0.1 root updating
/* ApplicationName=DBeaver 21.1.2 - SQLEditor <Script-1.sql> */ UPDATE test_db.txn_stocks set amount = 1000
WHERE product_id = 1 AND shop_id = 1
*** (2) HOLDS THE LOCK(S):
RECORD LOCKS space id 371 page no 3 n bits 80 index PRIMARY of table `test_db`.`txn_stocks` trx id 29917 lock_mode X locks rec but not gap
Record lock, heap no 3 PHYSICAL RECORD: n_fields 8; compact format; info bits 0
 0: len 4; hex 00000001; asc     ;;
 1: len 4; hex 00000002; asc     ;;
 2: len 6; hex 0000000074dd; asc     t ;;
 3: len 7; hex 39000001ea2346; asc 9    #F;;
 4: len 4; hex 000003e8; asc     ;;
 5: len 4; hex 80000000; asc     ;;
 6: len 4; hex 60ee1aa4; asc `   ;;
 7: len 7; hex 6e61676174616b; asc nagatak;;

*** (2) WAITING FOR THIS LOCK TO BE GRANTED:
RECORD LOCKS space id 371 page no 3 n bits 80 index PRIMARY of table `test_db`.`txn_stocks` trx id 29917 lock_mode X locks rec but not gap waiting
Record lock, heap no 2 PHYSICAL RECORD: n_fields 8; compact format; info bits 0
 0: len 4; hex 00000001; asc     ;;
 1: len 4; hex 00000001; asc     ;;
 2: len 6; hex 0000000074dc; asc     t ;;
 3: len 7; hex 38000001f60fd8; asc 8      ;;
 4: len 4; hex 000001f4; asc     ;;
 5: len 4; hex 80000001; asc     ;;
 6: len 4; hex 60ee1a94; asc `   ;;
 7: len 7; hex 6e61676174616b; asc nagatak;;

*** WE ROLL BACK TRANSACTION (2)
------------
TRANSACTIONS
------------
Trx id counter 29919
Purge done for trx's n:o < 29919 undo n:o < 0 state: running but idle
History list length 0
LIST OF TRANSACTIONS FOR EACH SESSION:
---TRANSACTION 421932680909256, not started
0 lock struct(s), heap size 1136, 0 row lock(s)
---TRANSACTION 421932680907448, not started
0 lock struct(s), heap size 1136, 0 row lock(s)
---TRANSACTION 421932680906544, not started
0 lock struct(s), heap size 1136, 0 row lock(s)
---TRANSACTION 29916, ACTIVE 98 sec
3 lock struct(s), heap size 1136, 2 row lock(s), undo log entries 2
MySQL thread id 937, OS thread handle 13078020096, query id 2746 localhost 127.0.0.1 root starting
/* ApplicationName=DBeaver 21.1.2 - SQLEditor <Script.sql> */ -- deadlockã®ç¢ºèª
show engine innodb status
--------
FILE I/O
--------
I/O thread 0 state: waiting for i/o request (insert buffer thread)
I/O thread 1 state: waiting for i/o request (log thread)
I/O thread 2 state: waiting for i/o request (read thread)
I/O thread 3 state: waiting for i/o request (read thread)
I/O thread 4 state: waiting for i/o request (read thread)
I/O thread 5 state: waiting for i/o request (read thread)
I/O thread 6 state: waiting for i/o request (write thread)
I/O thread 7 state: waiting for i/o request (write thread)
I/O thread 8 state: waiting for i/o request (write thread)
I/O thread 9 state: waiting for i/o request (write thread)
Pending normal aio reads: [0, 0, 0, 0] , aio writes: [0, 0, 0, 0] ,
 ibuf aio reads:, log i/o's:, sync i/o's:
Pending flushes (fsync) log: 0; buffer pool: 0
468 OS file reads, 4038 OS file writes, 1105 OS fsyncs
0.00 reads/s, 0 avg bytes/read, 0.38 writes/s, 0.24 fsyncs/s
-------------------------------------
INSERT BUFFER AND ADAPTIVE HASH INDEX
-------------------------------------
Ibuf: size 1, free list len 0, seg size 2, 0 merges
merged operations:
 insert 0, delete mark 0, delete 0
discarded operations:
 insert 0, delete mark 0, delete 0
Hash table size 34673, node heap has 0 buffer(s)
Hash table size 34673, node heap has 0 buffer(s)
Hash table size 34673, node heap has 0 buffer(s)
Hash table size 34673, node heap has 0 buffer(s)
Hash table size 34673, node heap has 0 buffer(s)
Hash table size 34673, node heap has 0 buffer(s)
Hash table size 34673, node heap has 0 buffer(s)
Hash table size 34673, node heap has 0 buffer(s)
0.00 hash searches/s, 0.00 non-hash searches/s
---
LOG
---
Log sequence number 9959971
Log flushed up to   9959971
Pages flushed up to 9959971
Last checkpoint at  9959962
0 pending log flushes, 0 pending chkp writes
665 log i/o's done, 0.14 log i/o's/second
----------------------
BUFFER POOL AND MEMORY
----------------------
Total large memory allocated 137428992
Dictionary memory allocated 123610
Buffer pool size   8191
Free buffers       7589
Database pages     602
Old database pages 216
Modified db pages  0
Pending reads      0
Pending writes: LRU 0, flush list 0, single page 0
Pages made young 0, not young 0
0.00 youngs/s, 0.00 non-youngs/s
Pages read 429, created 173, written 3177
0.00 reads/s, 0.00 creates/s, 0.00 writes/s
Buffer pool hit rate 1000 / 1000, young-making rate 0 / 1000 not 0 / 1000
Pages read ahead 0.00/s, evicted without access 0.00/s, Random read ahead 0.00/s
LRU len: 602, unzip_LRU len: 0
I/O sum[0]:cur[0], unzip sum[0]:cur[0]
--------------
ROW OPERATIONS
--------------
0 queries inside InnoDB, 0 queries in queue
0 read views open inside InnoDB
Process ID=95387, Main thread ID=13072355328, state: sleeping
Number of rows inserted 6262, updated 15, deleted 9, read 7098
0.00 inserts/s, 0.00 updates/s, 0.00 deletes/s, 0.00 reads/s
----------------------------
END OF INNODB MONITOR OUTPUT
============================

```


### Truncate ãƒ†ãƒ¼ãƒ–ãƒ«ã®åˆ‡ã‚Šæ¨ã¦
  - ç‰¹å¾´ï¼š
    - rollbackã§æˆ»ã›ãªã„
    - deleteã‚ˆã‚Šé«˜é€Ÿ
    - whereå¥ã¯ä½¿ç”¨ä¸å¯
    - auto_incrementã¯åˆæœŸå€¤ã¨ãªã‚‹

### ã‚·ã‚¹ãƒ†ãƒ å¤‰æ•°
  - å€¤ã®å–å¾—
    - @@session.å¤‰æ•°åï¼šç¾åœ¨ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³å†…ã§ã®å€¤ã‚’å–å¾—
    - @@local.å¤‰æ•°åï¼š@@sessionã¨åŒã˜
    - @@global.å¤‰æ•°åï¼šã‚µãƒ¼ãƒãƒ¼ä¸Šã®å€¤ã‚’å–å¾—
    - @@å¤‰æ•°åï¼šsession -> global ã®é †ç•ªã§å¤‰æ•°ã‚’å–å¾—
  - å€¤ã®å¤‰æ›´
    - set sessionï¼šç¾åœ¨ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³å†…ã§æœ‰åŠ¹
    - set Localï¼šSessionã¨åŒã˜
    - set globalï¼šå…¨ã¦ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ï¼ˆã‚µãƒ¼ãƒãƒ¼å…¨ä½“ï¼‰ã§æœ‰åŠ¹ï¼ˆDBå†èµ·å‹•ã¾ã§ï¼‰
      - â€»çœç•¥ã—ãŸå ´åˆã¯ã‚»ãƒƒã‚·ãƒ§ãƒ³å¤‰æ•°ã‚’å¤‰æ›´

```
show global variables like '%auto%';

SELECT @@global.autocommit;

set session autocommit = 0;
```

- autocommitãŒã‚ªãƒ•ã®å ´åˆã¯start transactionã‚’æµã™å¿…è¦ã¯ãªã„


### TIMESTAMPã¨DATETIMEã®é•ã„
  - TIMESTAMP
    - 4 bytes
    - 1970-01-01 00:00:01 UTC to 2038-01-09 03:14:07
    - ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³ã‚’è€ƒæ…®
  - DATETIME
    - 5 bytesï¼ˆæ—§ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã§ã¯8bytesï¼‰
    - 1000-01-01 00:00:00 to 9999-12-31 23:59:59
    - ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³ã‚’è€ƒæ…®ã—ãªã„

```
CREATE table test_date (
	dt datetime,
	ts timestamp
);

-- ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³ã®ç¢ºèª
 SELECT @@session.time_zone;

-- ç¾åœ¨æ™‚åˆ»ã‚’æŒ¿å…¥
 INSERT into test_date values (now(),now());

-- ãƒ¬ã‚³ãƒ¼ãƒ‰ã®ç¢ºèª
 SELECT * FROM test_date;

-- ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³ã®å¤‰æ›´
 set SESSION time_zone = "+1:00";
```

### ãƒ¦ãƒ¼ã‚¶ã®ä½œæˆã¨ç¢ºèª

```
-- ç¾åœ¨ãƒ¦ãƒ¼ã‚¶ã®ç¢ºèª
 SELECT USER();

-- ãƒ¦ãƒ¼ã‚¶ã®ä½œæˆ
 CREATE user {ãƒ¦ãƒ¼ã‚¶å}@{æ¥ç¶šå…ƒã®ãƒ›ã‚¹ãƒˆå…ˆ} identified by 'password';

 SELECT * from mysql.user;
```

### ãƒ¦ãƒ¼ã‚¶æ¨©é™ã®ä»˜ä¸

```
-- æ¨©é™ã®ä»˜ä¸
grant {æ¨©é™å} on {å¯¾è±¡ã®DBã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ} to {ãƒ¦ãƒ¼ã‚¶};

-- å…¨ã¦ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã«å¯¾ã—ã€selectå¯èƒ½
grant select on test_db.* to 'test_user'@'localhost';

-- ãŠè©¦ã—
grant all on test_db.* to 'test_user'@'localhost';
grant update, insert on test_db.* to 'test_user'@'localhost';
grant create, alter on test_db.* to 'test_user'@'localhost';

-- æ¨©é™ç¢ºèª
show grants for 'test_user'@'localhost';

-- æ¨©é™å‰Šé™¤
revoke all on test_db.* from 'test_user'@'localhost';
```

### æ–‡å­—ã‚³ãƒ¼ãƒ‰
  - utf8
    - 3bytes
    - ä¸€éƒ¨ã€è¡¨ç¤ºã§ããªã„æ–‡å­—ãŒå­˜åœ¨ã™ã‚‹
  - utf8mb4
    - 4bytes
    - çµµæ–‡å­—ãªã©ã«ã‚‚å¯¾å¿œ
  - â€»MySQLã®ä»Šå¾Œã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã§ã¯ã€utf8ãŒ4bytesã®utf8ã«ãªã‚Šã€3bytesã®utf8ã‚’æŒ‡å®šã™ã‚‹ã¨ãã«utf8mb3ã‚’ç¤ºã™å¿…è¦ãŒç”Ÿã˜ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹

```
create table test_db.char_test (
	mb4 varchar(20) character set 'utf8mb4',
	mb3 varchar(20) character set 'utf8'
);

INSERT into test_db.char_test(mb4) values('ğŸ˜…');
INSERT into test_db.char_test(mb3) values('ğŸ˜…');

SELECT * FROM  test_db.char_test;
```

### collation ç…§åˆé †åº
  - ç…§åˆé †åºã¯æ–‡å­—åˆ—ã‚’ã©ã®ã‚ˆã†ã«æ¯”è¼ƒã™ã‚‹ã‹ã«å½±éŸ¿ã™ã‚‹

#### utf8mb4_general_ci
  - è‹±å­—ã®å¤§æ–‡å­—å°æ–‡å­—ãŒåŒºåˆ¥ã•ã‚Œãªã„
  - åŠè§’ã¨å…¨è§’å°ã¯åŒºåˆ¥ã™ã‚‹

#### utf8mb4_unicode_ci
  - å¤§æ–‡å­—å°æ–‡å­—ã€å…¨è§’åŠè§’ã€ã²ã‚‰ãŒãªãƒ»ã‚«ã‚¿ã‚«ãƒŠã€æ¿éŸ³ãƒ»åŠæ¿éŸ³ãŒåŒºåˆ¥ã•ã‚Œãªã„

#### utf8mb4_bin
  - å…¨ã¦åŒºåˆ¥

### ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã¨ã‚ªãƒ—ãƒ†ã‚£ãƒã‚¤ã‚¶
  - ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã§é«˜é€Ÿã«å‡¦ç†ã‚’å®Œäº†ã§ãã‚‹
  - ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãŒä½¿ç”¨ã•ã‚Œã‚‹ã‚±ãƒ¼ã‚¹
    - å€¤ã®æ¯”è¼ƒï¼ˆ<ï¼‰ã‚„ç­‰ä¾¡ï¼ˆï¼ï¼‰
    - like 'æ–‡å­—%'
      - æ–‡å­—ã®å‰ã«%ãŒå…¥ã£ã¦ã„ã‚‹å ´åˆã«ã¯ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã¯ä½¿ç”¨ã•ã‚Œãªã„
    - è¡¨ã®çµåˆæ™‚
    - order byã«ã‚ˆã‚‹ã‚½ãƒ¼ãƒˆ
  - ã‚ªãƒ—ãƒ†ã‚£ãƒã‚¤ã‚¶ã¯å®Ÿéš›ã«ã©ã®ã‚ˆã†ã«ã—ã¦ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’å–å¾—ã™ã‚‹ã‹ã‚’æ±ºå®šã™ã‚‹åˆ¶å¾¡
    - ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ä½¿ã†ã‹ã©ã†ã‹
    - ãƒ‡ãƒ¼ã‚¿ã®ä»¶æ•°ã‚„åã‚Šã€ã¾ãŸã¯ãƒ†ãƒ¼ãƒ–ãƒ«ã®ã‚«ãƒ©ãƒ æ•°ã«ã‚ˆã£ã¦ã‚‚æŒ™å‹•ãŒå¤‰ã‚ã‚‹
